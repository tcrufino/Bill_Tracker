<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Bill Scheduler</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #2c3e50; --header-blue: #3498db; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: -apple-system, sans-serif; background: #eef2f5; margin: 0; padding: 15px; padding-bottom: 80px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 500px; margin: auto; margin-bottom: 20px; }
        h2 { font-size: 18px; color: var(--primary); margin-top: 0; text-align: center; }
        label { font-size: 11px; font-weight: bold; color: #7f8c8d; text-transform: uppercase; margin-top: 12px; display: block; }
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 15px; }
        
        /* Fixed Layout for Dashed Box Section */
        .date-picker-wrapper { 
            background: #f8f9fa; 
            padding: 12px; 
            border-radius: 12px; 
            border: 2px dashed #3498db; 
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Ensures the calendar input fits perfectly inside the dashed lines */
        #tempDate {
            margin: 0;
            width: 100%;
            border: 1px solid #ced4da;
            background: white;
        }

        .date-chip-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin-top: 12px; 
            width: 100%;
        }

        .date-chip { 
            background: var(--header-blue); 
            color: white; 
            padding: 8px 12px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            animation: pop 0.2s ease; 
        }
        .date-chip span { background: rgba(0,0,0,0.2); border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .btn-save { background: var(--success); color: white; border: none; font-weight: 800; margin-top: 20px; cursor: pointer; font-size: 16px; text-transform: uppercase; }
        .btn-back { background: #95a5a6; color: white; text-decoration: none; display: block; text-align: center; padding: 14px; border-radius: 10px; font-weight: bold; margin-top: 10px; text-transform: uppercase; font-size: 14px; }
        
        .master-item { background: white; border-radius: 12px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 6px solid var(--header-blue); max-width: 500px; margin: auto; }
        .item-main { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn-expand { background: #f1f3f5; border: 1px solid #ddd; color: var(--primary); width: auto; padding: 6px 12px; font-size: 11px; border-radius: 6px; font-weight: bold; }
        .btn-delete { background: var(--danger); color: white; width: auto; padding: 8px 12px; font-size: 11px; border: none; border-radius: 6px; font-weight: bold; }
        
        .dates-list { background: #f9f9f9; padding: 10px 15px; border-top: 1px solid #eee; display: none; }
        .date-row { font-size: 13px; color: #444; padding: 6px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="card">
        <h2>Schedule New Bill</h2>
        
        <label>Vendor Name</label>
        <input type="text" id="vName" placeholder="e.g. AppleTV, Verizon">
        
        <label>Amount</label>
        <input type="number" id="vAmt" step="0.01" placeholder="0.00">
        
        <label>Frequency</label>
        <select id="vType" onchange="toggleDateUI()">
            <option value="recurring">Recurring (Monthly)</option>
            <option value="seasonal" selected>Seasonal (Specific Dates)</option>
        </select>

        <div id="dateSelectorArea">
            <label>Select Year</label>
            <select id="vYear" onchange="syncCalendarToYear()">
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
            </select>

            <label id="dateLabel">Tap Dates to Add/Remove</label>
            <div class="date-picker-wrapper">
                <input type="date" id="tempDate" oninput="handleInstantDateAdd()">
                <div id="chipContainer" class="date-chip-container"></div>
            </div>
        </div>

        <button onclick="saveToMaster()" class="btn-save">Save & Sync to Index</button>
        <a href="index.html" class="btn-back">← Back to Tracker</a>
    </div>

    <h2 style="margin-top: 30px; text-align:center; font-size: 16px; color: #7f8c8d;">Scheduled Bills List</h2>
    <div id="masterList"></div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBsnuuEo8KSHb7taPQMpEJw8XkQVv3qW6k",
        authDomain: "billtrackersync-88b7a.firebaseapp.com",
        databaseURL: "https://billtrackersync-88b7a-default-rtdb.firebaseio.com",
        projectId: "billtrackersync-88b7a",
        storageBucket: "billtrackersync-88b7a.firebasestorage.app",
        messagingSenderId: "93682434120",
        appId: "1:93682434120:web:c3f3c3b968f975fd37d87d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let selectedDates = [];
    const monthShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    function syncCalendarToYear() {
        const year = document.getElementById('vYear').value;
        const dateInput = document.getElementById('tempDate');
        dateInput.value = `${year}-01-01`;
    }

    function handleInstantDateAdd() {
        const dateVal = document.getElementById('tempDate').value;
        if (!dateVal) return;
        const index = selectedDates.indexOf(dateVal);
        if (index > -1) {
            selectedDates.splice(index, 1);
        } else {
            selectedDates.push(dateVal);
        }
        renderChips();
    }

    function toggleDateUI() {
        const type = document.getElementById('vType').value;
        const label = document.getElementById('dateLabel');
        if(type === 'recurring') {
            label.innerText = "Select Start Date (Sets the Day)";
            selectedDates = [];
            renderChips();
        } else {
            label.innerText = "Tap Calendar to Pick Multiple Dates";
        }
    }

    function renderChips() {
        const container = document.getElementById('chipContainer');
        selectedDates.sort((a,b) => new Date(a) - new Date(b));
        container.innerHTML = selectedDates.map((d, i) => {
            const parts = d.split('-');
            return `<div class="date-chip">${parts[2]} ${monthShort[parseInt(parts[1])-1]} ${parts[0]} <span onclick="event.stopPropagation(); removeDate(${i})">✕</span></div>`;
        }).join('');
    }

    function removeDate(index) {
        selectedDates.splice(index, 1);
        renderChips();
    }

    function getWeekNumber(date) {
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
        return Math.ceil((date.getDate() + firstDay) / 7);
    }

    async function saveToMaster() {
        const name = document.getElementById('vName').value;
        const amt = parseFloat(document.getElementById('vAmt').value);
        const type = document.getElementById('vType').value;
        const chosenYear = document.getElementById('vYear').value;
        const dateInputVal = document.getElementById('tempDate').value;

        if (!name || isNaN(amt)) return alert("Missing Info");

        let datesToSync = [];
        if (type === 'recurring') {
            if(!dateInputVal) return alert("Select start date");
            const dayNum = new Date(dateInputVal + "T00:00:00").getDate();
            for (let m = 0; m < 12; m++) {
                const lastDay = new Date(chosenYear, m + 1, 0).getDate();
                const actualDay = Math.min(dayNum, lastDay);
                datesToSync.push(`${chosenYear}-${(m+1).toString().padStart(2,'0')}-${actualDay.toString().padStart(2,'0')}`);
            }
        } else {
            if(selectedDates.length === 0) return alert("Select dates");
            datesToSync = [...selectedDates];
        }

        await db.ref('master_schedule').push({ name, amt, type, dates: datesToSync });
        for (let dateStr of datesToSync) {
            const d = new Date(dateStr + "T00:00:00");
            const wNum = getWeekNumber(d);
            await db.ref(`data/${d.getFullYear()}/${d.getMonth()}/w${wNum}/bills`).push({
                date: `${d.getDate()} ${monthShort[d.getMonth()]}`, ven: name, amt: amt, paid: false
            });
        }
        location.reload();
    }

    async function deleteMaster(id, vName) {
        if(!confirm(`Delete ${vName}?`)) return;
        await db.ref('master_schedule/' + id).remove();
        const years = [2024, 2025, 2026, 2027];
        for(let y of years) {
            for(let m = 0; m < 12; m++) {
                const monthRef = db.ref(`data/${y}/${m}`);
                const snap = await monthRef.get();
                if(snap.exists()) {
                    const monthData = snap.val();
                    for(let w in monthData) {
                        if(monthData[w].bills) {
                            for(let key in monthData[w].bills) {
                                if(monthData[w].bills[key].ven === vName) {
                                    await db.ref(`data/${y}/${m}/${w}/bills/${key}`).remove();
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    db.ref('master_schedule').on('value', snap => {
        const listContainer = document.getElementById('masterList');
        listContainer.innerHTML = '';
        const data = snap.val();
        if(!data) return;
        Object.entries(data).forEach(([key, item]) => {
            const card = document.createElement('div');
            card.className = 'master-item';
            card.innerHTML = `<div class="item-main"><div class="item-info"><div class="item-title">${item.name}<span class="item-type">${item.type}</span></div><div style="font-weight:bold; color:var(--success);">$${item.amt.toFixed(2)}</div></div><button class="btn-expand" onclick="toggleDates('${key}')">VIEW (${item.dates.length})</button><button class="btn-delete" onclick="deleteMaster('${key}', '${item.name}')">DEL</button></div><div id="dates-${key}" class="dates-list"></div>`;
            listContainer.appendChild(card);
            const dList = document.getElementById('dates-'+key);
            item.dates.forEach(dStr => {
                const d = new Date(dStr + "T00:00:00");
                dList.innerHTML += `<div class="date-row"><span>${d.getDate()} ${monthShort[d.getMonth()]} ${d.getFullYear()}</span><span>$${item.amt.toFixed(2)}</span></div>`;
            });
        });
    });

    function toggleDates(id) {
        const el = document.getElementById('dates-' + id);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
    syncCalendarToYear();
</script>
</body>
</html>
