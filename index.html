<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bill Tracker</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #2c3e50; --header-blue: #3498db; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: -apple-system, sans-serif; background: #eef2f5; margin: 0; padding: 10px; padding-bottom: 100px; }
        
        .top-nav { background: var(--primary); padding: 12px; border-radius: 12px; display: flex; gap: 8px; margin-bottom: 15px; }
        select { flex: 1; padding: 10px; border-radius: 8px; border: none; font-size: 15px; font-weight: bold; background: white; height: 45px; }
        
        .summary-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .s-card { background: white; padding: 12px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 4px solid transparent; }
        .s-card.bills { border-left-color: var(--danger); }
        .s-card.income { border-left-color: var(--success); }
        .s-label { font-size: 10px; text-transform: uppercase; color: #7f8c8d; font-weight: 800; margin-bottom: 4px; }
        .s-val { font-size: 17px; font-weight: 800; }
        
        .week-box { background: white; border-radius: 15px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .week-header { background: var(--header-blue); color: white; padding: 10px 15px; font-weight: 800; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .week-content { padding: 12px; }
        
        .row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; width: 100%; }
        
        /* Adjusted widths to prevent text cutting */
        .day-sel { width: 85px !important; flex-shrink: 0; padding: 8px 4px !important; text-align: center; }
        .ven-in { flex-grow: 1; min-width: 0; }
        .amt-in { width: 70px !important; flex-shrink: 0; text-align: right; }
        
        input, select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; box-sizing: border-box; }
        
        .btn-add { background: var(--header-blue); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 800; width: 100%; margin: 8px 0 15px 0; font-size: 13px; text-transform: uppercase; }
        .btn-pay { background: var(--primary); color: white; border: none; padding: 10px 8px; border-radius: 8px; font-weight: 800; font-size: 11px; min-width: 55px; }
        .btn-pay.paid { background: var(--success); }
        .btn-del { color: #d1d8e0; border: none; background: none; font-size: 18px; padding: 0 5px; }
        
        .footer-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--primary); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-radius: 15px 15px 0 0; z-index: 100; }
        .foot-info { text-align: center; }
        .foot-info label { color: #bdc3c7; font-size: 9px; text-transform: uppercase; display: block; font-weight: 800; margin-bottom: 2px; }
        .foot-info span { color: #2ecc71; font-size: 20px; font-weight: 800; }
        .btn-db { background: white; color: var(--primary); text-decoration: none; padding: 10px 15px; border-radius: 10px; font-weight: 800; font-size: 11px; text-transform: uppercase; }
        
        .balance-row { text-align: right; font-size: 13px; font-weight: 800; border-top: 1px solid #f1f1f1; padding-top: 8px; color: #34495e; }
    </style>
</head>
<body>

    <div class="top-nav">
        <select id="yearSelect" onchange="loadData()">
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
        </select>
        <select id="monthSelect" onchange="loadData()">
            <option value="0">January</option><option value="1">February</option><option value="2">March</option>
            <option value="3">April</option><option value="4">May</option><option value="5">June</option>
            <option value="6">July</option><option value="7">August</option><option value="8">September</option>
            <option value="9">October</option><option value="10">November</option><option value="11">December</option>
        </select>
    </div>

    <div class="summary-container">
        <div class="s-card bills">
            <div class="s-label">Total Bills</div>
            <div class="s-val" id="totalBills" style="color: var(--danger);">$0.00</div>
        </div>
        <div class="s-card income">
            <div class="s-label">Total Income</div>
            <div class="s-val" id="totalIncome" style="color: var(--success);">$0.00</div>
        </div>
    </div>

    <div id="weeksContainer"></div>

    <div class="footer-bar">
        <div class="foot-info">
            <label>Monthly Remaining</label>
            <span id="monthlyRemaining">$0.00</span>
        </div>
        <a href="database.html" class="btn-db">Settings</a>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBsnuuEo8KSHb7taPQMpEJw8XkQVv3qW6k",
        authDomain: "billtrackersync-88b7a.firebaseapp.com",
        databaseURL: "https://billtrackersync-88b7a-default-rtdb.firebaseio.com",
        projectId: "billtrackersync-88b7a",
        storageBucket: "billtrackersync-88b7a.firebasestorage.app",
        messagingSenderId: "93682434120",
        appId: "1:93682434120:web:c3f3c3b968f975fd37d87d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const monthShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    function getWeeksInMonth(year, month) {
        const weeks = [];
        let firstDate = new Date(year, month, 1);
        let lastDate = new Date(year, month + 1, 0);
        let current = new Date(firstDate);
        current.setDate(current.getDate() - current.getDay());

        while (current <= lastDate) {
            let start = new Date(current);
            let end = new Date(current);
            end.setDate(end.getDate() + 6);
            weeks.push({ start, end });
            current.setDate(current.getDate() + 7);
        }
        return weeks;
    }

    async function loadData() {
        const year = document.getElementById('yearSelect').value;
        const month = document.getElementById('monthSelect').value;
        const weeks = getWeeksInMonth(year, parseInt(month));
        const container = document.getElementById('weeksContainer');
        container.innerHTML = '';

        let mTotalBills = 0, mTotalIncome = 0;

        for (let i = 0; i < weeks.length; i++) {
            const wNum = i + 1;
            const week = weeks[i];
            const wRef = db.ref(`data/${year}/${month}/w${wNum}`);
            const snap = await wRef.once('value');
            const data = snap.val() || { bills: {}, income: {} };

            let wBillsTotal = 0, wIncomeTotal = 0;
            const weekDiv = document.createElement('div');
            weekDiv.className = 'week-box';
            
            let billsHtml = '', incomeHtml = '';

            // Render Bills
            Object.entries(data.bills || {}).forEach(([id, b]) => {
                const amt = parseFloat(b.amt) || 0;
                wBillsTotal += amt;
                billsHtml += `
                    <div class="row">
                        <select class="day-sel" onchange="updateItem('${year}','${month}','w${wNum}','bills','${id}','date',this.value)">
                            ${getDayOptions(week, b.date)}
                        </select>
                        <input class="ven-in" type="text" placeholder="Vendor" value="${b.ven}" onchange="updateItem('${year}','${month}','w${wNum}','bills','${id}','ven',this.value)">
                        <input class="amt-in" type="number" placeholder="0" value="${b.amt}" onchange="updateItem('${year}','${month}','w${wNum}','bills','${id}','amt',this.value)">
                        <button class="btn-pay ${b.paid ? 'paid' : ''}" onclick="togglePaid('${year}','${month}','w${wNum}','${id}',${b.paid})">${b.paid ? 'PAID' : 'PAY'}</button>
                        <button class="btn-del" onclick="deleteItem('${year}','${month}','w${wNum}','bills','${id}')">×</button>
                    </div>`;
            });

            // Render Income
            Object.entries(data.income || {}).forEach(([id, inc]) => {
                const amt = parseFloat(inc.amt) || 0;
                wIncomeTotal += amt;
                incomeHtml += `
                    <div class="row">
                        <select class="day-sel" onchange="updateItem('${year}','${month}','w${wNum}','income','${id}','date',this.value)">
                            ${getDayOptions(week, inc.date)}
                        </select>
                        <input class="ven-in" type="text" placeholder="Source" value="${inc.ven}" onchange="updateItem('${year}','${month}','w${wNum}','income','${id}','ven',this.value)">
                        <input class="amt-in" type="number" placeholder="0" value="${inc.amt}" onchange="updateItem('${year}','${month}','w${wNum}','income','${id}','amt',this.value)">
                        <button class="btn-del" onclick="deleteItem('${year}','${month}','w${wNum}','income','${id}')">×</button>
                    </div>`;
            });

            mTotalBills += wBillsTotal; mTotalIncome += wIncomeTotal;

            weekDiv.innerHTML = `
                <div class="week-header">
                    <span>WEEK ${wNum}</span>
                    <span style="font-size:11px; opacity:0.9;">${week.start.getDate()} ${monthShort[week.start.getMonth()]} - ${week.end.getDate()} ${monthShort[week.end.getMonth()]}</span>
                </div>
                <div class="week-content">
                    <label class="s-label">Weekly Bills</label>
                    ${billsHtml}
                    <button class="btn-add" onclick="addItem('${year}','${month}','w${wNum}','bills')">+ Add Bill</button>
                    
                    <label class="s-label">Weekly Income</label>
                    ${incomeHtml}
                    <button class="btn-add" onclick="addItem('${year}','${month}','w${wNum}','income')">+ Add Income</button>
                    
                    <div class="balance-row">
                        Week Balance: <span style="color:${(wIncomeTotal - wBillsTotal) >= 0 ? 'var(--success)' : 'var(--danger)'}">$${(wIncomeTotal - wBillsTotal).toFixed(2)}</span>
                    </div>
                </div>`;
            container.appendChild(weekDiv);
        }

        document.getElementById('totalBills').innerText = `$${mTotalBills.toFixed(2)}`;
        document.getElementById('totalIncome').innerText = `$${mTotalIncome.toFixed(2)}`;
        const remaining = mTotalIncome - mTotalBills;
        document.getElementById('monthlyRemaining').innerText = `$${remaining.toFixed(2)}`;
        document.getElementById('monthlyRemaining').style.color = remaining >= 0 ? '#2ecc71' : '#e74c3c';
    }

    function getDayOptions(week, current) {
        let options = '';
        let d = new Date(week.start);
        for(let i=0; i<7; i++) {
            let val = `${d.getDate()} ${monthShort[d.getMonth()]}`;
            options += `<option value="${val}" ${val === current ? 'selected' : ''}>${val}</option>`;
            d.setDate(d.getDate() + 1);
        }
        return options;
    }

    async function addItem(y, m, w, type) {
        const ref = db.ref(`data/${y}/${m}/${w}/${type}`);
        await ref.push({ date: "1 " + monthShort[m], ven: "", amt: 0, paid: false });
        loadData();
    }

    async function updateItem(y, m, w, type, id, field, val) {
        await db.ref(`data/${y}/${m}/${w}/${type}/${id}`).update({ [field]: val });
        loadData();
    }

    async function togglePaid(y, m, w, id, current) {
        await db.ref(`data/${y}/${m}/${w}/bills/${id}`).update({ paid: !current });
        loadData();
    }

    async function deleteItem(y, m, w, type, id) {
        await db.ref(`data/${y}/${m}/${w}/${type}/${id}`).remove();
        loadData();
    }

    const today = new Date();
    document.getElementById('yearSelect').value = today.getFullYear();
    document.getElementById('monthSelect').value = today.getMonth();
    loadData();
</script>
</body>
</html>
